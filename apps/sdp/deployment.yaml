---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: shadowpulse-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Mi
  storageClassName: local-path
  volumeMode: Filesystem

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sdr
  labels:
    app: sdr
    app.watchgrid.io/name: sdp
    app.watchgrid.io/managed-by: watchgrid
    app.watchgrid.io/component: sdr
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: sdr
      app.watchgrid.io/name: sdp
  template:
    metadata:
      labels:
        app: sdr
        app.watchgrid.io/name: sdp
        app.watchgrid.io/managed-by: watchgrid
        app.watchgrid.io/component: sdr
      annotations:
        container.apparmor.security.beta.kubernetes.io/sdr: unconfined
    spec:
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      terminationGracePeriodSeconds: 45
      containers:
        - name: sdr
          image: colabspecl/sdr:latest
          imagePullPolicy: Always
          workingDir: /app
          env:
            - name: PYTHONUNBUFFERED
              value: "1"
            - name: SDR_DEVICE
              value: "HackRF"
          ports:
            - containerPort: 8000
              name: http
            - containerPort: 5555
              name: fft

          # Give the app time to release HackRF / ZMQ sockets before kill -9
          lifecycle:
            preStop:
              exec:
                command:
                  # Try graceful shutdown if your app supports it; otherwise short sleep
                  - /bin/sh
                  - -c
                  - |
                    echo "PreStop: giving SDR stack time to release device and ports"
                    # If your app has a shutdown endpoint, call it here, e.g.:
                    # curl -s http://127.0.0.1:8000/shutdown || true
                    sleep 5

          securityContext:
            runAsUser: 0
            privileged: true
            capabilities:
              add:
                - NET_ADMIN

          volumeMounts:
            - name: usbdev
              mountPath: /dev/bus/usb
            - name: shadowpulse-storage
              mountPath: /app/data

      volumes:
        - name: usbdev
          hostPath:
            path: /dev/bus/usb
            type: Directory
        - name: shadowpulse-storage
          persistentVolumeClaim:
            claimName: shadowpulse-pvc

---
apiVersion: v1
kind: Service
metadata:
  name: sdr
  labels:
    app: sdr
    app.watchgrid.io/name: sdp
    app.watchgrid.io/managed-by: watchgrid
    app.watchgrid.io/component: sdr
spec:
  selector:
    app: sdr
    app.watchgrid.io/name: sdp
  ports:
    - name: http
      port: 8000
      targetPort: 8000
    - name: fft
      port: 5555
      targetPort: 5555
  type: ClusterIP
