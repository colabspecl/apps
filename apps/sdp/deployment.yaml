---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: shadowpulse-pvc
spec:
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: 10Mi
  storageClassName: local-path
  volumeMode: Filesystem

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sdr
  labels:
    app: sdr
    app.watchgrid.io/name: sdp
    app.watchgrid.io/managed-by: watchgrid
    app.watchgrid.io/component: sdr
spec:
  replicas: 1

  # avoid overlap so device/ports aren't double-bound
  strategy:
    type: Recreate

  selector:
    matchLabels:
      app: sdr
      app.watchgrid.io/name: sdp
  template:
    metadata:
      labels:
        app: sdr
        app.watchgrid.io/name: sdp
        app.watchgrid.io/managed-by: watchgrid
        app.watchgrid.io/component: sdr
    spec:
      terminationGracePeriodSeconds: 60
      containers:
        - name: sdr
          image: colabspecl/sdr:latest
          imagePullPolicy: Always
          workingDir: /app
          env:
            - name: PYTHONUNBUFFERED
              value: "1"
            - name: SDR_DEVICE
              value: "HackRF"
          ports:
            - containerPort: 8000
              hostPort: 8000     # <-- bind node port 8000
              name: http
            - containerPort: 5555
              name: fft          # internal only
          lifecycle:
            preStop:
              exec:
                command: ["/bin/sh","-c","sleep 5"]
          securityContext:
            runAsUser: 0
            privileged: true
            capabilities:
              add: ["NET_ADMIN"]
          volumeMounts:
            - name: usbdev
              mountPath: /dev/bus/usb
            - name: shadowpulse-storage
              mountPath: /app/data
      volumes:
        - name: usbdev
          hostPath:
            path: /dev/bus/usb
            type: Directory
        - name: shadowpulse-storage
          persistentVolumeClaim:
            claimName: shadowpulse-pvc

---
apiVersion: v1
kind: Service
metadata:
  name: sdr
  labels:
    app: sdr
    app.watchgrid.io/name: sdp
    app.watchgrid.io/managed-by: watchgrid
    app.watchgrid.io/component: sdr
spec:
  selector:
    app: sdr
    app.watchgrid.io/name: sdp
  type: ClusterIP
  ports:
    - name: http
      port: 8000
      targetPort: 8000
    - name: fft
      port: 5555
      targetPort: 5555
