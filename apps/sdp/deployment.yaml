---
apiVersion: v1
kind: Service
metadata:
  name: sdr-headless
  labels:
    app: sdr
    app.watchgrid.io/name: sdp
    app.watchgrid.io/managed-by: watchgrid
    app.watchgrid.io/component: sdr
spec:
  clusterIP: None
  selector:
    app: sdr
    app.watchgrid.io/name: sdp
  ports:
    - name: http
      port: 8000
      targetPort: 8000
    - name: fft
      port: 5555
      targetPort: 5555

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: sdr
  labels:
    app: sdr
    app.watchgrid.io/name: sdp
    app.watchgrid.io/managed-by: watchgrid
    app.watchgrid.io/component: sdr
spec:
  serviceName: sdr-headless
  replicas: 1
  updateStrategy:
    type: RollingUpdate
  selector:
    matchLabels:
      app: sdr
      app.watchgrid.io/name: sdp
  template:
    metadata:
      labels:
        app: sdr
        app.watchgrid.io/name: sdp
        app.watchgrid.io/managed-by: watchgrid
        app.watchgrid.io/component: sdr
    spec:
      terminationGracePeriodSeconds: 60
      containers:
        - name: sdr
          image: colabspecl/sdr:latest
          imagePullPolicy: Always
          workingDir: /app
          env:
            - name: PYTHONUNBUFFERED
              value: "1"
            - name: SDR_DEVICE
              value: "HackRF"
          ports:
            - containerPort: 8000
              hostPort: 8000          # exposes node:8000 for WireGuard curl
              name: http
            - containerPort: 5555
              name: fft               # internal only
          readinessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 15
            timeoutSeconds: 10
            failureThreshold: 6
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 6
          startupProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 15
            failureThreshold: 20
          lifecycle:
            preStop:
              exec:
                command: ["/bin/sh","-c","sleep 5"]  # let sockets/USB release
          securityContext:
            runAsUser: 0
            privileged: true
            capabilities:
              add: ["NET_ADMIN"]
          volumeMounts:
            - name: usbdev
              mountPath: /dev/bus/usb
            - name: shadowpulse-storage
              mountPath: /app/data
      volumes:
        - name: usbdev
          hostPath:
            path: /dev/bus/usb
            type: Directory
  volumeClaimTemplates:
    - metadata:
        name: shadowpulse-storage
      spec:
        accessModes: ["ReadWriteOnce"]
        storageClassName: local-path
        resources:
          requests:
            storage: 10Mi

---
apiVersion: v1
kind: Service
metadata:
  name: sdr
  labels:
    app: sdr
    app.watchgrid.io/name: sdp
    app.watchgrid.io/managed-by: watchgrid
    app.watchgrid.io/component: sdr
spec:
  selector:
    app: sdr
    app.watchgrid.io/name: sdp
  type: ClusterIP
  ports:
    - name: http
      port: 8000
      targetPort: 8000
    - name: fft
      port: 5555
      targetPort: 5555
