apiVersion: apps/v1
kind: Deployment
metadata:
  name: sdr
  labels:
    app: sdr
    app.watchgrid.io/name: sdp
    app.watchgrid.io/managed-by: watchgrid
    app.watchgrid.io/component: sdr
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sdr
      app.watchgrid.io/name: sdp
  template:
    metadata:
      labels:
        app: sdr
        app.watchgrid.io/name: sdp
        app.watchgrid.io/managed-by: watchgrid
        app.watchgrid.io/component: sdr
      annotations:
        container.apparmor.security.beta.kubernetes.io/sdr: unconfined
    spec:
      containers:
        - name: sdr
          image: colabspecl/sdr:latest
          imagePullPolicy: Always
          workingDir: /app
          env:
            - name: PYTHONUNBUFFERED
              value: "1"
            - name: SDR_DEVICE
              value: "HackRF"
          ports:
            - containerPort: 8000
              name: http
            - containerPort: 5555
              name: fft
          readinessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 15
            timeoutSeconds: 10
            failureThreshold: 6
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 6
          startupProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 15
            failureThreshold: 20
          securityContext:
            runAsUser: 0
            privileged: true
            capabilities:
              add:
                - NET_ADMIN
          volumeMounts:
            - name: usbdev
              mountPath: /dev/bus/usb
            - name: shadowpulse-storage
              mountPath: /app/data
      volumes:
        - name: usbdev
          hostPath:
            path: /dev/bus/usb
            type: Directory
        - name: shadowpulse-storage
          persistentVolumeClaim:
            claimName: shadowpulse-pvc

---
apiVersion: v1
kind: Service
metadata:
  name: sdr
  labels:
    app: sdr
    app.watchgrid.io/name: sdp
    app.watchgrid.io/managed-by: watchgrid
    app.watchgrid.io/component: sdr
spec:
  selector:
    app: sdr
    app.watchgrid.io/name: sdp
  ports:
    - name: http
      port: 8000
      targetPort: 8000
    - name: fft
      port: 5555
      targetPort: 5555
  type: ClusterIP

---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: shadowpulse-pv
  labels:
    type: local
spec:
  capacity:
    storage: 10Mi
  accessModes:
    - ReadWriteOnce
  hostPath:
    path: /mnt/shadowpulse-data
  persistentVolumeReclaimPolicy: Retain

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: shadowpulse-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Mi
  volumeName: shadowpulse-pv
